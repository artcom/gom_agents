#!/usr/bin/env ruby

require 'rubygems'
$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')
require 'enttec-dmx-usb-pro-tools'

#Thread.abort_on_exception = true
$stderr.sync = true
$stdout.sync = true

def redirect_to logfile
  puts " -- redirecting stdout/stderr to: #{logfile}"
  f = File.open(logfile, File::WRONLY|File::APPEND|File::CREAT)
  f.sync = true
  $stderr = $stdout = f
end

def main args
  dmx_node_url = args.shift
  (logfile = args.shift) and (redirect_to logfile)
  puts " -- starting enttec daemon: #{Time.now}"
  daemon = Gom::Remote::Daemon.new(dmx_node_url) do |path|
    Enttec::DmxNode.new path
  end
  daemon.run # { |*args| puts " .. tacker -#{args.inspect}" }

rescue => e
  puts " ## #{e}\n -> #{e.backtrace.join "\n    "}"
end

main ARGV
# vim: syntax=ruby
